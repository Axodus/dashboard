name: Dashboard Conda

on: 
  push:
    branches:
      - develop

jobs:
  check-conda:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Check if Conda is installed
        run: |
          # Array of possible conda installation paths
          CONDA_PATHS=(
            "/opt/conda/bin/conda"
            "~/anaconda3/bin/conda"
            "/usr/local/anaconda3/bin/conda"
            "~/miniconda3/bin/conda"
            "/root/miniconda/bin/conda"
            "~/Anaconda3/Scripts/conda"
            "$CONDA/bin/conda"
          )
  
          CONDA_EXE=""
          for path in "${CONDA_PATHS[@]}"; do
            if [ -x "$(eval echo $path)" ]; then
              CONDA_EXE=$(eval echo $path)
              break
            fi
          done
  
          if [ -z "$CONDA_EXE" ]; then
            echo "Please install Anaconda or Miniconda with Python 3.10+ first."
            echo "See: https://www.anaconda.com/distribution/"
            exit 1
          else
            echo "Conda found at: $(dirname $CONDA_EXE)"
          fi
        shell: bash
  
  install:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Install Environment
        run: |
          if conda env list | grep -q '^dashboard '; then
            echo "Environment already exists."
          else
            conda env create -f environment_conda.yml
          fi
      - name: List Conda Environments
        run: conda env list

  init-conda:
    needs: install
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Check and Initialize Conda
        run: |
          # Check if conda is installed
          if ! command -v conda &> /dev/null; then
            echo "Conda is not installed. Please install Miniconda or Anaconda."
            exit 1
          fi
  
          # Check if conda is already initialized in the shell
          if ! grep -q "conda.sh" ~/.bashrc; then
            echo "Conda not initialized. Initializing now..."
            source ~/miniconda3/etc/profile.d/conda.sh
            conda init bash
            echo "Conda initialization added to .bashrc. Please restart your shell or run 'source ~/.bashrc' for changes to take effect."
          else
            echo "Conda is already initialized."
          fi
      - name: Restaet bash
        run: source ~/.bashrc

  activate-conda:
    needs: init-conda
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Get Conda Info
        run: |
          conda info
      - name: Activate Conda environment
        run: |
          conda activate dashboard

  run-dashboard:
    needs: [activate-conda, install]
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Verify Environment Before Running
        run: conda env list

      - name: Run Streamlit Dashboard
        run: |
          streamlit run main.py --server.headless true || echo "Streamlit execution failed with exit code $?"
